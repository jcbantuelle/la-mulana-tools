<h1>Modify Your Save File</h1>

<div id="modify-save-file-form-container">
  <%= form_with url: '/save_file/download', method: :post, html: {:target => '_blank'} do |form| %>
    <%= form.hidden_field :file_name, value: @file_name %>
    <%= form.hidden_field :valid, value: 1 %>
    <div class="col-6">
      <h2 class="text-muted">Starting Location</h2>
      <div>
        <%= form.radio_button :starting_location, "preset", checked: @starting_location.present? %>
        <%= form.label :starting_location_preset, "Preset" %>
        &nbsp;
        <%= form.radio_button :starting_location, "custom", checked: @starting_location.nil? %>
        <%= form.label :starting_location_custom, "Custom" %>
      </div>
      <br />
      <div class="starting-location-container" id="preset-container" <%= 'style="display: none;"'.html_safe if @starting_location.nil? %>>
        <%= form.select :preset,
          @presets.map{ |preset|
            [preset[:name], {
              'data-zone': preset[:zone],
              'data-room': preset[:room],
              'data-screen': preset[:screen],
              'data-x_position': preset[:x_position],
              'data-y_position': preset[:y_position]
            }]
          },
          selected: @starting_location.try(:[], :name),
          include_blank: '- Select Preset -' %>
      </div>
      <div class="starting-location-container" id="custom-container" <%= 'style="display: none;"'.html_safe if @starting_location.present? %>>
        <div class="row">
          <div class="col">
            <%= form.label :zone, 'Zone:', class: "form-label" %>
            <%= form.text_field :zone, value: @save_file.zone, class: "form-control" %>
          </div>
          <div class="col">
            <%= form.label :room, 'Room:', class: "form-label" %>
            <%= form.text_field :room, value: @save_file.room, class: "form-control" %>
          </div>
          <div class="col">
            <%= form.label :screen, 'Screen:', class: "form-label" %>
            <%= form.text_field :screen, value: @save_file.screen, class: "form-control" %>
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col">
            <%= form.label :x_position, 'X Position:', class: "form-label" %>
            <%= form.text_field :x_position, value: @save_file.x_position, class: "form-control" %>
          </div>
          <div class="col">
            <%= form.label :y_position, 'Y Position:', class: "form-label" %>
            <%= form.text_field :y_position, value: @save_file.y_position, class: "form-control" %>
          </div>
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col">
          <%= form.label :game_time, 'Game Time:', class: 'form-label' %> (<span id="formatted-game-time"><%= formatted_game_time(@save_file.game_time) %></span>)
          <%= form.text_field :game_time, value: @save_file.game_time, class: 'form-control' %>
        </div>
        <div class="col">
          <%= form.label :max_hp, 'Max HP:', class: 'form-label' %> (<span id="formatted-max-hp"><%= @save_file.max_hp * 32 %></span>)
          <%= form.text_field :max_hp, value: @save_file.max_hp, class: 'form-control' %>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <%= form.label :current_hp, 'Current HP:', class: 'form-label' %>
          <%= form.text_field :current_hp, value: @save_file.current_hp, class: 'form-control' %>
        </div>
        <div class="col">
          <%= form.label :current_exp, 'Current EXP:', class: 'form-label' %>
          <%= form.text_field :current_exp, value: @save_file.current_exp, class: 'form-control' %>
        </div>
      </div>
      <hr />
    </div>

  <p><strong>Flags:</strong> <%= @save_file.flags.snapshot.join(' | ') %></p>
  <p><strong>Inventory:</strong> <%= @save_file.inventory.snapshot.join(' | ') %></p>
  <p><strong>Held Main Weapon:</strong> <%= @save_file.held_main_weapon %></p>
  <p><strong>Held Sub Weapon:</strong> <%= @save_file.held_sub_weapon %></p>
  <p><strong>Held Use Item:</strong> <%= @save_file.held_use_item %></p>
  <p><strong>Held Main Weapon Slot:</strong> <%= @save_file.held_main_weapon_slot %></p>
  <p><strong>Held Sub Weapon Slot:</strong> <%= @save_file.held_sub_weapon_slot %></p>
  <p><strong>Held Use Item Slot:</strong> <%= @save_file.held_use_item_slot %></p>
  <p><strong>Total Emails:</strong> <%= @save_file.total_emails %></p>
  <p><strong>Received Emails:</strong> <%= @save_file.received_emails %></p>

    <%= form.submit "Generate Modified Save File" %>
  <% end %>
</div>

<script type="text/javascript">
  $(function() {
    $('input[type=radio][name=starting_location]').change(function() {
      $('.starting-location-container').hide()
      $('#'+this.value+'-container').show()
    })

    $('#preset').change(function() {
      let option = $('option:selected', this)
      $('#zone').val(option.data('zone'))
      $('#room').val(option.data('room'))
      $('#screen').val(option.data('screen'))
      $('#x_position').val(option.data('x_position'))
      $('#y_position').val(option.data('y_position'))
    })

    $('#game_time').keyup(function() {
      let game_time = parseInt($(this).val())
      // I hate Javascript so much
      let milliseconds = game_time % 1000
      let seconds = Math.floor(game_time / 1000)
      let minutes = Math.floor(seconds / 60)
      seconds = seconds % 60
      let hours = Math.floor(minutes / 60)
      minutes = minutes % 60
      $('#formatted-game-time').text(hours + 'h ' + minutes + 'm ' + seconds + '.' + ('000' + milliseconds).slice(-3) + 's')
    })

    $('#max_hp').keyup(function() {
      let max_hp = parseInt($(this).val())
      if (isNaN(max_hp)) max_hp = 0
      $('#formatted-max-hp').text(max_hp * 32)
    })
  })
</script>
